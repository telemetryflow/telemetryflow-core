#================================================================================================
# TELEMETRYFLOW - POSTGRESQL CONFIGURATION
#================================================================================================
# PostgreSQL 15 Configuration for TelemetryFlow Platform
# Optimized for RBAC, User Management, and Dashboard Storage
#
# Last Updated: 2025-11-25
# Maintainer: DevOpsCorner Indonesia
#================================================================================================

#================================================================================================
# CONNECTION SETTINGS
#================================================================================================

# Listen on all interfaces
listen_addresses = '*'

# Maximum number of concurrent connections
max_connections = 200

# Superuser reserved connections
superuser_reserved_connections = 3

#================================================================================================
# MEMORY SETTINGS
#================================================================================================

# Shared memory for buffer cache (25% of total RAM recommended)
# Adjust based on your system: 256MB for 1GB RAM, 1GB for 4GB RAM, 4GB for 16GB RAM
shared_buffers = 256MB

# Memory for sorting and hash operations (25% of RAM / max_connections)
work_mem = 4MB

# Memory for maintenance operations (index creation, VACUUM)
maintenance_work_mem = 64MB

# Maximum memory for prepared statements
max_prepared_transactions = 0

# Effective cache size (50-75% of total RAM)
effective_cache_size = 1GB

#================================================================================================
# QUERY PLANNER
#================================================================================================

# Cost of random page access
random_page_cost = 1.1

# Cost of sequential page access
seq_page_cost = 1.0

# Planner's assumption of effective cache size
effective_io_concurrency = 200

#================================================================================================
# WRITE AHEAD LOG (WAL)
#================================================================================================

# WAL level (replica for replication, minimal for standalone)
wal_level = replica

# Size of WAL segment files
wal_segment_size = 16MB

# Maximum size of WAL files between checkpoints
max_wal_size = 1GB

# Minimum size of WAL files to keep
min_wal_size = 80MB

# WAL writer delay
wal_writer_delay = 200ms

# Commit delay for group commits
commit_delay = 0

# Fsync method (fdatasync is default and recommended)
fsync = on
synchronous_commit = on
wal_sync_method = fdatasync

#================================================================================================
# CHECKPOINTS
#================================================================================================

# Time between automatic checkpoints
checkpoint_timeout = 5min

# Ratio of checkpoint completion target
checkpoint_completion_target = 0.9

# Warning threshold for checkpoint spacing
checkpoint_warning = 30s

#================================================================================================
# AUTOVACUUM
#================================================================================================

# Enable autovacuum daemon
autovacuum = on

# Autovacuum logging
log_autovacuum_min_duration = 0

# Autovacuum parameters
autovacuum_max_workers = 3
autovacuum_naptime = 1min
autovacuum_vacuum_threshold = 50
autovacuum_vacuum_scale_factor = 0.2
autovacuum_vacuum_cost_delay = 20ms
autovacuum_vacuum_cost_limit = -1

#================================================================================================
# LOGGING
#================================================================================================

# Where to log
log_destination = 'stderr'
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_file_mode = 0600
log_rotation_age = 1d
log_rotation_size = 100MB

# When to log
log_min_messages = warning
log_min_error_statement = error
log_min_duration_statement = 1000

# What to log
log_checkpoints = on
log_connections = on
log_disconnections = on
log_duration = off
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_lock_waits = on
log_statement = 'none'
log_temp_files = 0

# Log query performance
log_autovacuum_min_duration = 0
log_error_verbosity = default

#================================================================================================
# STATISTICS
#================================================================================================

# Enable query statistics
track_activities = on
track_counts = on
track_io_timing = on
track_functions = all

# Statistics target (increase for better query plans)
default_statistics_target = 100

# Shared preload libraries (pg_stat_statements for query tracking)
shared_preload_libraries = 'pg_stat_statements'

# pg_stat_statements configuration
pg_stat_statements.max = 10000
pg_stat_statements.track = all
pg_stat_statements.track_utility = on
pg_stat_statements.save = on

#================================================================================================
# CLIENT CONNECTION DEFAULTS
#================================================================================================

# Timezone
timezone = 'Asia/Jakarta'

# Locale settings
lc_messages = 'en_US.UTF-8'
lc_monetary = 'en_US.UTF-8'
lc_numeric = 'en_US.UTF-8'
lc_time = 'en_US.UTF-8'

# Default text search configuration
default_text_search_config = 'pg_catalog.english'

# Client encoding
client_encoding = 'UTF8'

#================================================================================================
# LOCK MANAGEMENT
#================================================================================================

# Deadlock timeout
deadlock_timeout = 1s

# Maximum locks per transaction
max_locks_per_transaction = 64

#================================================================================================
# REPLICATION (for future use)
#================================================================================================

# Maximum number of replication connections
max_wal_senders = 10

# Minimum number of WAL segments retained for replication
wal_keep_size = 128MB

# Replication timeout
wal_sender_timeout = 60s

# Hot standby settings
hot_standby = on
hot_standby_feedback = off

#================================================================================================
# PERFORMANCE TUNING
#================================================================================================

# Parallel query settings
max_worker_processes = 8
max_parallel_workers_per_gather = 2
max_parallel_workers = 8
max_parallel_maintenance_workers = 2

# Background writer
bgwriter_delay = 200ms
bgwriter_lru_maxpages = 100
bgwriter_lru_multiplier = 2.0

# Statement timeout (0 = disabled, use with caution)
statement_timeout = 0

# Lock timeout (0 = disabled)
lock_timeout = 0

# Idle in transaction timeout
idle_in_transaction_session_timeout = 0

#================================================================================================
# SECURITY
#================================================================================================

# SSL (disabled by default, enable in production)
ssl = off
# ssl_cert_file = 'server.crt'
# ssl_key_file = 'server.key'
# ssl_ca_file = 'root.crt'

# Password encryption
password_encryption = scram-sha-256

#================================================================================================
# CUSTOM SETTINGS FOR TELEMETRYFLOW
#================================================================================================

# Increase shared buffers for dashboard queries
# Optimize for read-heavy RBAC queries
# Enable statement tracking for performance monitoring

#================================================================================================
# END OF CONFIGURATION
#================================================================================================
