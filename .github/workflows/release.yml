# =============================================================================
# TelemetryFlow Core - Release Workflow
# =============================================================================
#
# TelemetryFlow Core - Identity and Access Management Service
# Copyright (c) 2024-2026 DevOpsCorner Indonesia. All rights reserved.
#
# This workflow builds and releases TelemetryFlow Core:
# - Docker images for multiple platforms
# - Source code archives
# - Release notes with changelog
#
# Platforms:
# - Linux: Docker images (amd64, arm64)
# - Source: tar.gz archives
#
# Triggers:
# - Push tags matching v*.*.*
# - Manual workflow dispatch
#
# =============================================================================

name: Release - TelemetryFlow Core

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        default: '1.0.0'
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '10.24.0'
  PRODUCT_NAME: TelemetryFlow Core
  VENDOR: DevOpsCorner Indonesia
  MAINTAINER: support@telemetryflow.id
  DESCRIPTION: Enterprise-grade Identity and Access Management service for TelemetryFlow - the observability platform that provides unified metrics, logs, and traces collection following OpenTelemetry standards.
  LICENSE: Apache-2.0
  HOMEPAGE: https://telemetryflow.id
  REGISTRY_DOCKER: docker.io
  REGISTRY_GHCR: ghcr.io
  IMAGE_NAME: telemetryflow/telemetryflow-core
  GHCR_IMAGE_NAME: ghcr.io/${{ github.repository }}

permissions:
  contents: write
  packages: write

jobs:
  # ===========================================================================
  # Prepare Release
  # ===========================================================================
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      commit: ${{ steps.version.outputs.commit }}
      branch: ${{ steps.version.outputs.branch }}
      build_time: ${{ steps.version.outputs.build_time }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "commit=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "branch=$(git rev-parse --abbrev-ref HEAD)" >> $GITHUB_OUTPUT
          echo "build_time=$(date -u '+%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT

  # ===========================================================================
  # Build Linux Binaries
  # ===========================================================================
  build-linux:
    name: Build Linux (${{ matrix.arch }})
    runs-on: ubuntu-latest
    needs: prepare
    strategy:
      matrix:
        arch: [amd64, arm64]
        include:
          - arch: amd64
            pkg_target: node18-linux-x64
          - arch: arm64
            pkg_target: node18-linux-arm64
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        run: pnpm build

      - name: Build standalone binary
        run: |
          pnpm pkg . --out-path build --targets ${{ matrix.pkg_target }}
          mv build/telemetryflow-core build/telemetryflow-core-linux-${{ matrix.arch }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: binary-linux-${{ matrix.arch }}
          path: build/telemetryflow-core-linux-${{ matrix.arch }}
          retention-days: 1

  # ===========================================================================
  # Build Windows Binary
  # ===========================================================================
  build-windows:
    name: Build Windows (amd64)
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        run: pnpm build

      - name: Build standalone binary
        run: |
          pnpm pkg . --out-path build --targets node18-win-x64
          mv build/telemetryflow-core.exe build/telemetryflow-core-windows-amd64.exe

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: binary-windows-amd64
          path: build/telemetryflow-core-windows-amd64.exe
          retention-days: 1

  # ===========================================================================
  # Build macOS Binaries
  # ===========================================================================
  build-macos:
    name: Build macOS (${{ matrix.arch }})
    runs-on: macos-latest
    needs: prepare
    strategy:
      matrix:
        arch: [amd64, arm64]
        include:
          - arch: amd64
            pkg_target: node18-macos-x64
          - arch: arm64
            pkg_target: node18-macos-arm64
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        run: pnpm build

      - name: Build standalone binary
        run: |
          pnpm pkg . --out-path build --targets ${{ matrix.pkg_target }}
          mv build/telemetryflow-core build/telemetryflow-core-darwin-${{ matrix.arch }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: binary-darwin-${{ matrix.arch }}
          path: build/telemetryflow-core-darwin-${{ matrix.arch }}
          retention-days: 1

  # ===========================================================================
  # Package RPM
  # ===========================================================================
  package-rpm:
    name: Package RPM (${{ matrix.arch }})
    runs-on: ubuntu-latest
    needs: [prepare, build-linux]
    strategy:
      matrix:
        arch: [amd64, arm64]
        include:
          - arch: amd64
            rpm_arch: x86_64
          - arch: arm64
            rpm_arch: aarch64
    steps:
      - name: Install RPM build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y rpm

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: binary-linux-${{ matrix.arch }}
          path: dist

      - name: Create RPM structure
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          BINARY_NAME=telemetryflow-core
          mkdir -p rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          mkdir -p rpmbuild/SOURCES/${BINARY_NAME}-${VERSION}

          # Copy binary
          cp dist/${BINARY_NAME}-linux-${{ matrix.arch }} \
             rpmbuild/SOURCES/${BINARY_NAME}-${VERSION}/${BINARY_NAME}
          chmod +x rpmbuild/SOURCES/${BINARY_NAME}-${VERSION}/${BINARY_NAME}

          # Copy config
          mkdir -p rpmbuild/SOURCES/${BINARY_NAME}-${VERSION}/config
          cp .env.example rpmbuild/SOURCES/${BINARY_NAME}-${VERSION}/config/telemetryflow-core.env

          # Create tarball
          cd rpmbuild/SOURCES
          tar czf ${BINARY_NAME}-${VERSION}.tar.gz ${BINARY_NAME}-${VERSION}

      - name: Create RPM spec file
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          BINARY_NAME=telemetryflow-core
          CHANGELOG_DATE=$(date '+%a %b %d %Y')

          cat > rpmbuild/SPECS/${BINARY_NAME}.spec << EOF
          Name:           ${BINARY_NAME}
          Version:        ${{ needs.prepare.outputs.version }}
          Release:        1%{?dist}
          Summary:        ${{ env.DESCRIPTION }}
          License:        ${{ env.LICENSE }}
          URL:            ${{ env.HOMEPAGE }}
          Source0:        %{name}-%{version}.tar.gz

          %description
          ${{ env.PRODUCT_NAME }} is an enterprise-grade Identity and Access Management
          service for the TelemetryFlow platform. It provides comprehensive user management,
          role-based access control, and multi-tenant architecture.

          %prep
          %setup -q

          %install
          mkdir -p %{buildroot}/usr/local/bin
          mkdir -p %{buildroot}/etc/telemetryflow-core
          mkdir -p %{buildroot}/var/lib/telemetryflow-core
          mkdir -p %{buildroot}/var/log/telemetryflow-core
          mkdir -p %{buildroot}/usr/lib/systemd/system

          install -m 755 ${BINARY_NAME} %{buildroot}/usr/local/bin/
          install -m 644 config/telemetryflow-core.env %{buildroot}/etc/telemetryflow-core/

          cat > %{buildroot}/usr/lib/systemd/system/telemetryflow-core.service << 'SYSTEMD'
          [Unit]
          Description=${{ env.PRODUCT_NAME }} - Identity and Access Management Service
          Documentation=${{ env.HOMEPAGE }}
          After=network-online.target postgresql.service
          Wants=network-online.target

          [Service]
          Type=simple
          User=telemetryflow
          Group=telemetryflow
          EnvironmentFile=/etc/telemetryflow-core/telemetryflow-core.env
          ExecStart=/usr/local/bin/telemetryflow-core
          Restart=always
          RestartSec=10
          StandardOutput=journal
          StandardError=journal
          SyslogIdentifier=telemetryflow-core
          LimitNOFILE=65536
          MemoryMax=1G

          [Install]
          WantedBy=multi-user.target
          SYSTEMD

          %pre
          getent group telemetryflow >/dev/null || groupadd -r telemetryflow
          getent passwd telemetryflow >/dev/null || \
            useradd -r -g telemetryflow -d /var/lib/telemetryflow-core -s /sbin/nologin \
            -c "${{ env.PRODUCT_NAME }}" telemetryflow
          exit 0

          %post
          systemctl daemon-reload

          %preun
          if [ \$1 -eq 0 ]; then
            systemctl stop telemetryflow-core >/dev/null 2>&1 || :
            systemctl disable telemetryflow-core >/dev/null 2>&1 || :
          fi

          %postun
          systemctl daemon-reload

          %files
          %defattr(-,root,root,-)
          /usr/local/bin/${BINARY_NAME}
          %config(noreplace) /etc/telemetryflow-core/telemetryflow-core.env
          /usr/lib/systemd/system/telemetryflow-core.service
          %dir %attr(755,telemetryflow,telemetryflow) /var/lib/telemetryflow-core
          %dir %attr(755,telemetryflow,telemetryflow) /var/log/telemetryflow-core

          %changelog
          * ${CHANGELOG_DATE} ${{ env.VENDOR }} <${{ env.MAINTAINER }}> - ${{ needs.prepare.outputs.version }}-1
          - Release version ${{ needs.prepare.outputs.version }}
          EOF

      - name: Build RPM
        run: |
          rpmbuild --define "_topdir $(pwd)/rpmbuild" \
                   --target ${{ matrix.rpm_arch }} \
                   -bb rpmbuild/SPECS/telemetryflow-core.spec

      - name: Upload RPM artifact
        uses: actions/upload-artifact@v4
        with:
          name: rpm-${{ matrix.arch }}
          path: rpmbuild/RPMS/**/*.rpm
          retention-days: 1

  # ===========================================================================
  # Package DEB
  # ===========================================================================
  package-deb:
    name: Package DEB (${{ matrix.arch }})
    runs-on: ubuntu-latest
    needs: [prepare, build-linux]
    strategy:
      matrix:
        arch: [amd64, arm64]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: binary-linux-${{ matrix.arch }}
          path: dist

      - name: Create DEB structure
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          BINARY_NAME=telemetryflow-core
          PKG_DIR=${BINARY_NAME}_${VERSION}_${{ matrix.arch }}
          mkdir -p ${PKG_DIR}/DEBIAN
          mkdir -p ${PKG_DIR}/usr/local/bin
          mkdir -p ${PKG_DIR}/etc/telemetryflow-core
          mkdir -p ${PKG_DIR}/var/lib/telemetryflow-core
          mkdir -p ${PKG_DIR}/var/log/telemetryflow-core
          mkdir -p ${PKG_DIR}/lib/systemd/system

          # Copy binary
          cp dist/${BINARY_NAME}-linux-${{ matrix.arch }} \
             ${PKG_DIR}/usr/local/bin/${BINARY_NAME}
          chmod 755 ${PKG_DIR}/usr/local/bin/${BINARY_NAME}

          # Copy config
          cp .env.example ${PKG_DIR}/etc/telemetryflow-core/telemetryflow-core.env

      - name: Create DEB control files
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          BINARY_NAME=telemetryflow-core
          PKG_DIR=${BINARY_NAME}_${VERSION}_${{ matrix.arch }}

          # Control file
          cat > ${PKG_DIR}/DEBIAN/control << EOF
          Package: ${BINARY_NAME}
          Version: ${VERSION}
          Section: utils
          Priority: optional
          Architecture: ${{ matrix.arch }}
          Maintainer: ${{ env.VENDOR }} <${{ env.MAINTAINER }}>
          Description: ${{ env.DESCRIPTION }}
           ${{ env.PRODUCT_NAME }} is an enterprise-grade Identity and Access Management
           service for the TelemetryFlow platform. It provides comprehensive user management,
           role-based access control, and multi-tenant architecture.
          Homepage: ${{ env.HOMEPAGE }}
          EOF

          # Pre-install script
          cat > ${PKG_DIR}/DEBIAN/preinst << 'EOF'
          #!/bin/bash
          set -e
          getent group telemetryflow >/dev/null || groupadd -r telemetryflow
          getent passwd telemetryflow >/dev/null || \
            useradd -r -g telemetryflow -d /var/lib/telemetryflow-core -s /usr/sbin/nologin \
            -c "TelemetryFlow Core" telemetryflow
          exit 0
          EOF
          chmod 755 ${PKG_DIR}/DEBIAN/preinst

          # Post-install script
          cat > ${PKG_DIR}/DEBIAN/postinst << 'EOF'
          #!/bin/bash
          set -e
          chown -R telemetryflow:telemetryflow /var/lib/telemetryflow-core
          chown -R telemetryflow:telemetryflow /var/log/telemetryflow-core
          systemctl daemon-reload
          echo "TelemetryFlow Core installed successfully!"
          echo "To start: sudo systemctl start telemetryflow-core"
          echo "To enable on boot: sudo systemctl enable telemetryflow-core"
          exit 0
          EOF
          chmod 755 ${PKG_DIR}/DEBIAN/postinst

          # Pre-remove script
          cat > ${PKG_DIR}/DEBIAN/prerm << 'EOF'
          #!/bin/bash
          set -e
          if [ "$1" = "remove" ]; then
            systemctl stop telemetryflow-core >/dev/null 2>&1 || true
            systemctl disable telemetryflow-core >/dev/null 2>&1 || true
          fi
          exit 0
          EOF
          chmod 755 ${PKG_DIR}/DEBIAN/prerm

          # Post-remove script
          cat > ${PKG_DIR}/DEBIAN/postrm << 'EOF'
          #!/bin/bash
          set -e
          systemctl daemon-reload
          exit 0
          EOF
          chmod 755 ${PKG_DIR}/DEBIAN/postrm

          # Conffiles
          cat > ${PKG_DIR}/DEBIAN/conffiles << EOF
          /etc/telemetryflow-core/telemetryflow-core.env
          EOF

      - name: Create systemd service
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          BINARY_NAME=telemetryflow-core
          PKG_DIR=${BINARY_NAME}_${VERSION}_${{ matrix.arch }}
          cat > ${PKG_DIR}/lib/systemd/system/telemetryflow-core.service << EOF
          [Unit]
          Description=${{ env.PRODUCT_NAME }} - Identity and Access Management Service
          Documentation=${{ env.HOMEPAGE }}
          After=network-online.target postgresql.service
          Wants=network-online.target

          [Service]
          Type=simple
          User=telemetryflow
          Group=telemetryflow
          EnvironmentFile=/etc/telemetryflow-core/telemetryflow-core.env
          ExecStart=/usr/local/bin/telemetryflow-core
          Restart=always
          RestartSec=10
          StandardOutput=journal
          StandardError=journal
          SyslogIdentifier=telemetryflow-core
          LimitNOFILE=65536
          MemoryMax=1G

          [Install]
          WantedBy=multi-user.target
          EOF

      - name: Build DEB package
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          BINARY_NAME=telemetryflow-core
          PKG_DIR=${BINARY_NAME}_${VERSION}_${{ matrix.arch }}
          dpkg-deb --build ${PKG_DIR}
          mkdir -p packages
          mv ${PKG_DIR}.deb packages/

      - name: Upload DEB artifact
        uses: actions/upload-artifact@v4
        with:
          name: deb-${{ matrix.arch }}
          path: packages/*.deb
          retention-days: 1

  # ===========================================================================
  # Package Windows EXE (ZIP with installer script)
  # ===========================================================================
  package-windows:
    name: Package Windows EXE
    runs-on: ubuntu-latest
    needs: [prepare, build-windows]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: binary-windows-amd64
          path: dist

      - name: Create Windows package
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          BINARY_NAME=telemetryflow-core
          PKG_DIR=${BINARY_NAME}-${VERSION}-windows-amd64
          mkdir -p ${PKG_DIR}

          # Copy binary
          cp dist/${BINARY_NAME}-windows-amd64.exe ${PKG_DIR}/${BINARY_NAME}.exe

          # Copy config
          cp .env.example ${PKG_DIR}/telemetryflow-core.env

          # Create install script
          cat > ${PKG_DIR}/install.ps1 << 'EOF'
          # TelemetryFlow Core Windows Installer
          # Run as Administrator

          $ErrorActionPreference = "Stop"

          $InstallDir = "C:\Program Files\TelemetryFlow\Core"
          $ConfigDir = "C:\ProgramData\TelemetryFlow\Core"
          $LogDir = "C:\ProgramData\TelemetryFlow\Core\logs"
          $ServiceName = "TelemetryFlowCore"

          Write-Host "Installing TelemetryFlow Core..." -ForegroundColor Green

          # Create directories
          New-Item -ItemType Directory -Force -Path $InstallDir | Out-Null
          New-Item -ItemType Directory -Force -Path $ConfigDir | Out-Null
          New-Item -ItemType Directory -Force -Path $LogDir | Out-Null

          # Copy files
          Copy-Item -Path ".\telemetryflow-core.exe" -Destination "$InstallDir\telemetryflow-core.exe" -Force
          Copy-Item -Path ".\telemetryflow-core.env" -Destination "$ConfigDir\telemetryflow-core.env" -Force

          # Add to PATH
          $envPath = [Environment]::GetEnvironmentVariable("Path", "Machine")
          if ($envPath -notlike "*$InstallDir*") {
              [Environment]::SetEnvironmentVariable("Path", "$envPath;$InstallDir", "Machine")
          }

          # Create Windows Service
          if (Get-Service -Name $ServiceName -ErrorAction SilentlyContinue) {
              Stop-Service -Name $ServiceName -Force
              sc.exe delete $ServiceName
          }

          $binPath = "`"$InstallDir\telemetryflow-core.exe`""
          New-Service -Name $ServiceName `
                      -DisplayName "TelemetryFlow Core" `
                      -Description "TelemetryFlow Core - Identity and Access Management Service" `
                      -BinaryPathName $binPath `
                      -StartupType Automatic

          Write-Host "TelemetryFlow Core installed successfully!" -ForegroundColor Green
          Write-Host "To start: Start-Service $ServiceName" -ForegroundColor Yellow
          Write-Host "To check status: Get-Service $ServiceName" -ForegroundColor Yellow
          EOF

          # Create uninstall script
          cat > ${PKG_DIR}/uninstall.ps1 << 'EOF'
          # TelemetryFlow Core Windows Uninstaller
          # Run as Administrator

          $ErrorActionPreference = "Stop"

          $InstallDir = "C:\Program Files\TelemetryFlow\Core"
          $ServiceName = "TelemetryFlowCore"

          Write-Host "Uninstalling TelemetryFlow Core..." -ForegroundColor Yellow

          # Stop and remove service
          if (Get-Service -Name $ServiceName -ErrorAction SilentlyContinue) {
              Stop-Service -Name $ServiceName -Force -ErrorAction SilentlyContinue
              sc.exe delete $ServiceName
          }

          # Remove from PATH
          $envPath = [Environment]::GetEnvironmentVariable("Path", "Machine")
          $newPath = ($envPath.Split(';') | Where-Object { $_ -ne $InstallDir }) -join ';'
          [Environment]::SetEnvironmentVariable("Path", $newPath, "Machine")

          # Remove files
          Remove-Item -Path $InstallDir -Recurse -Force -ErrorAction SilentlyContinue

          Write-Host "TelemetryFlow Core uninstalled successfully!" -ForegroundColor Green
          EOF

          # Create README
          cat > ${PKG_DIR}/README.txt << EOF
          TelemetryFlow Core v${VERSION}
          ================================

          Installation:
          1. Run PowerShell as Administrator
          2. Navigate to this directory
          3. Run: .\install.ps1

          Manual Usage:
          telemetryflow-core.exe

          Configuration:
          Edit C:\ProgramData\TelemetryFlow\Core\telemetryflow-core.env

          Documentation: https://docs.telemetryflow.id
          Support: support@telemetryflow.id

          Copyright (c) 2024-2026 DevOpsCorner Indonesia
          EOF

          # Create ZIP
          zip -r ${BINARY_NAME}-${VERSION}-windows-amd64.zip ${PKG_DIR}

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-amd64
          path: telemetryflow-core-*.zip
          retention-days: 1

  # ===========================================================================
  # Package macOS DMG
  # ===========================================================================
  package-macos:
    name: Package macOS DMG (${{ matrix.arch }})
    runs-on: macos-latest
    needs: [prepare, build-macos]
    strategy:
      matrix:
        arch: [amd64, arm64]
        include:
          - arch: amd64
            macos_arch: x86_64
            display_name: Intel
          - arch: arm64
            macos_arch: arm64
            display_name: Apple Silicon
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: binary-darwin-${{ matrix.arch }}
          path: dist

      - name: Create DMG structure
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          BINARY_NAME=telemetryflow-core
          DMG_DIR="dmg-contents"

          mkdir -p "${DMG_DIR}"

          # Copy binary
          cp dist/${BINARY_NAME}-darwin-${{ matrix.arch }} \
             "${DMG_DIR}/${BINARY_NAME}"
          chmod +x "${DMG_DIR}/${BINARY_NAME}"

          # Copy config
          cp .env.example "${DMG_DIR}/telemetryflow-core.env"

          # Create install script
          cat > "${DMG_DIR}/install.sh" << 'EOF'
          #!/bin/bash
          # TelemetryFlow Core macOS Installer

          set -e

          INSTALL_DIR="/usr/local/bin"
          CONFIG_DIR="/etc/telemetryflow-core"
          DATA_DIR="/var/lib/telemetryflow-core"
          LOG_DIR="/var/log/telemetryflow-core"
          LAUNCH_DAEMON="/Library/LaunchDaemons/id.telemetryflow.core.plist"

          echo "Installing TelemetryFlow Core..."

          # Create directories
          sudo mkdir -p "${CONFIG_DIR}"
          sudo mkdir -p "${DATA_DIR}"
          sudo mkdir -p "${LOG_DIR}"

          # Copy files
          sudo cp telemetryflow-core "${INSTALL_DIR}/"
          sudo chmod +x "${INSTALL_DIR}/telemetryflow-core"

          if [ ! -f "${CONFIG_DIR}/telemetryflow-core.env" ]; then
            sudo cp telemetryflow-core.env "${CONFIG_DIR}/"
          fi

          # Create LaunchDaemon
          sudo tee "${LAUNCH_DAEMON}" > /dev/null << 'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>Label</key>
              <string>id.telemetryflow.core</string>
              <key>ProgramArguments</key>
              <array>
                  <string>/usr/local/bin/telemetryflow-core</string>
              </array>
              <key>EnvironmentVariables</key>
              <dict>
                  <key>NODE_ENV</key>
                  <string>production</string>
              </dict>
              <key>RunAtLoad</key>
              <true/>
              <key>KeepAlive</key>
              <true/>
              <key>StandardOutPath</key>
              <string>/var/log/telemetryflow-core/telemetryflow-core.log</string>
              <key>StandardErrorPath</key>
              <string>/var/log/telemetryflow-core/telemetryflow-core-error.log</string>
          </dict>
          </plist>
          PLIST

          echo ""
          echo "TelemetryFlow Core installed successfully!"
          echo ""
          echo "To start the service:"
          echo "  sudo launchctl load ${LAUNCH_DAEMON}"
          echo ""
          echo "To stop the service:"
          echo "  sudo launchctl unload ${LAUNCH_DAEMON}"
          echo ""
          echo "To check status:"
          echo "  sudo launchctl list | grep telemetryflow"
          EOF
          chmod +x "${DMG_DIR}/install.sh"

          # Create uninstall script
          cat > "${DMG_DIR}/uninstall.sh" << 'EOF'
          #!/bin/bash
          # TelemetryFlow Core macOS Uninstaller

          set -e

          LAUNCH_DAEMON="/Library/LaunchDaemons/id.telemetryflow.core.plist"

          echo "Uninstalling TelemetryFlow Core..."

          # Stop service
          if [ -f "${LAUNCH_DAEMON}" ]; then
            sudo launchctl unload "${LAUNCH_DAEMON}" 2>/dev/null || true
            sudo rm -f "${LAUNCH_DAEMON}"
          fi

          # Remove binary
          sudo rm -f /usr/local/bin/telemetryflow-core

          echo "TelemetryFlow Core uninstalled successfully!"
          echo "Configuration files are preserved in /etc/telemetryflow-core/"
          EOF
          chmod +x "${DMG_DIR}/uninstall.sh"

          # Create README
          cat > "${DMG_DIR}/README.txt" << EOF
          TelemetryFlow Core v${VERSION}
          ================================
          Architecture: ${{ matrix.display_name }} (${{ matrix.macos_arch }})

          Installation:
          1. Open Terminal
          2. Navigate to this directory
          3. Run: ./install.sh

          Manual Usage:
          telemetryflow-core

          Configuration:
          Edit /etc/telemetryflow-core/telemetryflow-core.env

          Documentation: https://docs.telemetryflow.id
          Support: support@telemetryflow.id

          Copyright (c) 2024-2026 DevOpsCorner Indonesia
          EOF

      - name: Create DMG
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          BINARY_NAME=telemetryflow-core
          DMG_NAME="${BINARY_NAME}-${VERSION}-darwin-${{ matrix.arch }}.dmg"
          VOLUME_NAME="${{ env.PRODUCT_NAME }} ${VERSION}"

          # Prevent Spotlight indexing which can cause "Resource busy" errors
          touch dmg-contents/.metadata_never_index

          # Detach any existing mounted volumes with the same name
          hdiutil detach "/Volumes/${VOLUME_NAME}" 2>/dev/null || true

          # Remove any existing DMG file
          rm -f "${DMG_NAME}"

          # Sync filesystem and wait for file handles to be released
          sync
          sleep 2

          hdiutil create -volname "${VOLUME_NAME}" \
                         -srcfolder "dmg-contents" \
                         -ov -format UDZO \
                         "${DMG_NAME}"

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: dmg-${{ matrix.arch }}
          path: telemetryflow-core-*.dmg
          retention-days: 1

  # ===========================================================================
  # Create Tarballs
  # ===========================================================================
  package-tarball:
    name: Create Tarball (${{ matrix.os }}-${{ matrix.arch }})
    runs-on: ubuntu-latest
    needs: [prepare, build-linux, build-macos]
    strategy:
      matrix:
        include:
          - os: linux
            arch: amd64
          - os: linux
            arch: arm64
          - os: darwin
            arch: amd64
          - os: darwin
            arch: arm64
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: binary-${{ matrix.os }}-${{ matrix.arch }}
          path: dist

      - name: Create tarball
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          BINARY_NAME=telemetryflow-core
          TAR_DIR="${BINARY_NAME}-${VERSION}-${{ matrix.os }}-${{ matrix.arch }}"
          mkdir -p "${TAR_DIR}"

          cp dist/${BINARY_NAME}-${{ matrix.os }}-${{ matrix.arch }} \
             "${TAR_DIR}/${BINARY_NAME}"
          chmod +x "${TAR_DIR}/${BINARY_NAME}"
          cp .env.example "${TAR_DIR}/telemetryflow-core.env"
          cp README.md "${TAR_DIR}/" 2>/dev/null || true
          cp LICENSE "${TAR_DIR}/" 2>/dev/null || true

          tar -czvf "${TAR_DIR}.tar.gz" "${TAR_DIR}"

      - name: Upload tarball artifact
        uses: actions/upload-artifact@v4
        with:
          name: tarball-${{ matrix.os }}-${{ matrix.arch }}
          path: telemetryflow-core-*.tar.gz
          retention-days: 1

  # ===========================================================================
  # Build Docker Images
  # ===========================================================================
  build-docker:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        if: vars.DOCKERHUB_USERNAME != ''
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_DOCKER }}
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_GHCR }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.REGISTRY_DOCKER }}/${{ env.IMAGE_NAME }}
            ${{ env.GHCR_IMAGE_NAME }}
          flavor: |
            latest=false
          tags: |
            # Semantic versioning from tags
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            # Manual version input
            type=raw,value=${{ needs.prepare.outputs.version }},enable=${{ github.event_name == 'workflow_dispatch' }}
            # Latest for releases
            type=raw,value=latest,enable=true
          labels: |
            org.opencontainers.image.title=${{ env.PRODUCT_NAME }}
            org.opencontainers.image.description=${{ env.DESCRIPTION }}
            org.opencontainers.image.vendor=TelemetryFlow
            org.opencontainers.image.licenses=${{ env.LICENSE }}
            org.opencontainers.image.url=${{ env.HOMEPAGE }}
            io.telemetryflow.product=${{ env.PRODUCT_NAME }}
            io.telemetryflow.component=iam-service
            io.telemetryflow.platform=CEOP

      - name: Build and push Docker images
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            VERSION=${{ needs.prepare.outputs.version }}
            GIT_COMMIT=${{ needs.prepare.outputs.commit }}
            GIT_BRANCH=${{ needs.prepare.outputs.branch }}
            BUILD_TIME=${{ needs.prepare.outputs.build_time }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: true
          sbom: true

  # ===========================================================================
  # Create Source Archives
  # ===========================================================================
  build-source:
    name: Create Source Archives
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        run: pnpm build

      - name: Create source archive
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          # Create source archive with built application
          ARCHIVE_NAME="telemetryflow-core-${VERSION}-source"
          mkdir -p "${ARCHIVE_NAME}"
          
          # Copy essential files
          cp -r dist "${ARCHIVE_NAME}/"
          cp -r src "${ARCHIVE_NAME}/"
          cp -r config "${ARCHIVE_NAME}/"
          cp -r docs "${ARCHIVE_NAME}/"
          cp -r scripts "${ARCHIVE_NAME}/"
          cp package.json "${ARCHIVE_NAME}/"
          cp pnpm-lock.yaml "${ARCHIVE_NAME}/"
          cp tsconfig.json "${ARCHIVE_NAME}/"
          cp nest-cli.json "${ARCHIVE_NAME}/"
          cp jest.config.js "${ARCHIVE_NAME}/"
          cp Dockerfile "${ARCHIVE_NAME}/"
          cp docker-compose.yml "${ARCHIVE_NAME}/"
          cp README.md "${ARCHIVE_NAME}/"
          cp LICENSE "${ARCHIVE_NAME}/"
          cp CHANGELOG.md "${ARCHIVE_NAME}/"
          cp CONTRIBUTING.md "${ARCHIVE_NAME}/"
          cp SECURITY.md "${ARCHIVE_NAME}/"
          
          # Create installation script
          cat > "${ARCHIVE_NAME}/install.sh" << 'EOF'
          #!/bin/bash
          # TelemetryFlow Core Installation Script
          
          set -e
          
          echo "Installing TelemetryFlow Core..."
          
          # Check Node.js
          if ! command -v node &> /dev/null; then
            echo "Error: Node.js is required but not installed."
            echo "Please install Node.js 18+ from https://nodejs.org/"
            exit 1
          fi
          
          # Check pnpm
          if ! command -v pnpm &> /dev/null; then
            echo "Installing pnpm..."
            npm install -g pnpm
          fi
          
          # Install dependencies (production only)
          echo "Installing dependencies..."
          pnpm install --prod --frozen-lockfile
          
          # Generate secrets if not exists
          if [ ! -f ".env" ]; then
            echo "Generating secrets..."
            node scripts/generate-secrets.js
          fi
          
          echo ""
          echo "TelemetryFlow Core installed successfully!"
          echo ""
          echo "Next steps:"
          echo "1. Configure your .env file with database settings"
          echo "2. Run database migrations: pnpm db:migrate:seed"
          echo "3. Start the service: pnpm start"
          echo ""
          echo "For more information, see README.md"
          EOF
          chmod +x "${ARCHIVE_NAME}/install.sh"
          
          # Create README for the archive
          cat > "${ARCHIVE_NAME}/INSTALL.md" << EOF
          # TelemetryFlow Core v${VERSION}
          
          ## Quick Start
          
          1. **Install dependencies:**
             \`\`\`bash
             ./install.sh
             \`\`\`
          
          2. **Configure environment:**
             \`\`\`bash
             cp .env.example .env
             # Edit .env with your database settings
             \`\`\`
          
          3. **Initialize database:**
             \`\`\`bash
             pnpm db:migrate:seed
             \`\`\`
          
          4. **Start the service:**
             \`\`\`bash
             pnpm start
             \`\`\`
          
          ## Docker Deployment
          
          \`\`\`bash
          docker-compose --profile core up -d
          \`\`\`
          
          ## Documentation
          
          - [README.md](README.md) - Main documentation
          - [CONTRIBUTING.md](CONTRIBUTING.md) - Development guide
          - [docs/](docs/) - Additional documentation
          
          ## Support
          
          - Homepage: ${HOMEPAGE}
          - Email: ${MAINTAINER}
          - Issues: https://github.com/telemetryflow/telemetryflow-core/issues
          EOF
          
          # Create tarball
          tar -czf "${ARCHIVE_NAME}.tar.gz" "${ARCHIVE_NAME}"
          
          # Create ZIP for Windows users
          zip -r "${ARCHIVE_NAME}.zip" "${ARCHIVE_NAME}"

      - name: Upload source artifacts
        uses: actions/upload-artifact@v4
        with:
          name: source-archives
          path: |
            telemetryflow-core-*.tar.gz
            telemetryflow-core-*.zip
          retention-days: 1

  # ===========================================================================
  # Create GitHub Release
  # ===========================================================================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs:
      - prepare
      - build-docker
      - build-source
      - package-rpm
      - package-deb
      - package-windows
      - package-macos
      - package-tarball
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download source archives
        uses: actions/download-artifact@v4
        with:
          name: source-archives
          path: artifacts/source

      - name: Download RPM packages
        uses: actions/download-artifact@v4
        with:
          pattern: rpm-*
          path: artifacts/rpm
          merge-multiple: true

      - name: Download DEB packages
        uses: actions/download-artifact@v4
        with:
          pattern: deb-*
          path: artifacts/deb
          merge-multiple: true

      - name: Download Windows packages
        uses: actions/download-artifact@v4
        with:
          pattern: windows-*
          path: artifacts/windows
          merge-multiple: true

      - name: Download macOS DMG packages
        uses: actions/download-artifact@v4
        with:
          pattern: dmg-*
          path: artifacts/dmg
          merge-multiple: true

      - name: Download tarballs
        uses: actions/download-artifact@v4
        with:
          pattern: tarball-*
          path: artifacts/tarball
          merge-multiple: true

      - name: Prepare release assets
        run: |
          mkdir -p release

          echo "=== Downloaded artifacts structure ==="
          find artifacts -type f -ls

          echo ""
          echo "=== Collecting source archives ==="
          find artifacts/source -name "*.tar.gz" -exec cp {} release/ \; 2>/dev/null || echo "No source tar.gz files found"
          find artifacts/source -name "*.zip" -exec cp {} release/ \; 2>/dev/null || echo "No source zip files found"

          echo ""
          echo "=== Collecting RPM packages ==="
          find artifacts/rpm -name "*.rpm" -exec cp {} release/ \; 2>/dev/null || echo "No RPM packages found"

          echo ""
          echo "=== Collecting DEB packages ==="
          find artifacts/deb -name "*.deb" -exec cp {} release/ \; 2>/dev/null || echo "No DEB packages found"

          echo ""
          echo "=== Collecting Windows packages ==="
          find artifacts/windows -name "*.zip" -exec cp {} release/ \; 2>/dev/null || echo "No Windows packages found"

          echo ""
          echo "=== Collecting macOS DMG packages ==="
          find artifacts/dmg -name "*.dmg" -exec cp {} release/ \; 2>/dev/null || echo "No DMG packages found"

          echo ""
          echo "=== Collecting tarballs ==="
          find artifacts/tarball -name "*.tar.gz" -exec cp {} release/ \; 2>/dev/null || echo "No tarballs found"

          echo ""
          echo "=== Release directory contents ==="
          ls -la release/

          echo ""
          echo "=== Package summary ==="
          echo "Source archives: $(ls release/*-source.tar.gz 2>/dev/null | wc -l)"
          echo "RPM packages:    $(ls release/*.rpm 2>/dev/null | wc -l)"
          echo "DEB packages:    $(ls release/*.deb 2>/dev/null | wc -l)"
          echo "Windows ZIP:     $(ls release/*-windows-*.zip 2>/dev/null | wc -l)"
          echo "macOS DMG:       $(ls release/*.dmg 2>/dev/null | wc -l)"
          echo "Tarballs:        $(ls release/*-linux-*.tar.gz release/*-darwin-*.tar.gz 2>/dev/null | wc -l)"
          echo "Total files:     $(ls release/ | wc -l)"

          if [ -z "$(ls -A release/)" ]; then
            echo "ERROR: No release assets found!"
            exit 1
          fi

      - name: Generate checksums
        run: |
          cd release
          sha256sum * > checksums-sha256.txt
          cat checksums-sha256.txt

      - name: Create tag if not exists (workflow_dispatch)
        if: github.event_name == 'workflow_dispatch'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          TAG_NAME="v${{ needs.prepare.outputs.version }}"
          if ! git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            git tag -a "$TAG_NAME" -m "Release $TAG_NAME"
            git push origin "$TAG_NAME"
            echo "Created tag: $TAG_NAME"
          else
            echo "Tag $TAG_NAME already exists"
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: "${{ env.PRODUCT_NAME }} v${{ needs.prepare.outputs.version }}"
          tag_name: "v${{ needs.prepare.outputs.version }}"
          draft: false
          prerelease: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.prerelease == 'true' }}
          generate_release_notes: true
          files: |
            release/*
          body: |
            ## ${{ env.PRODUCT_NAME }} v${{ needs.prepare.outputs.version }}

            ### What's New

            TelemetryFlow Core is a lightweight, production-ready Identity and Access Management (IAM) service extracted from the larger TelemetryFlow Platform. This release provides complete identity and access management with enterprise-grade security features.

            ### Core Features

            - **5-Tier RBAC System**: Super Admin, Administrator, Developer, Viewer, Demo roles with hierarchical permissions
            - **Multi-tenant Architecture**: Tenant ‚Üí Organization ‚Üí Workspace hierarchy for data isolation
            - **Domain-Driven Design**: Clean architecture with DDD patterns and CQRS implementation
            - **Enterprise Security**: JWT authentication, Argon2 password hashing, role-based access control
            - **Observability**: OpenTelemetry tracing, Winston logging, Swagger API documentation
            - **Audit Logging**: Complete audit trail stored in ClickHouse for compliance

            ### Technology Stack

            - **Backend**: NestJS 11.x with TypeScript 5.9
            - **Database**: PostgreSQL 16 (IAM data) + ClickHouse (audit logs)
            - **Authentication**: JWT with Passport
            - **Observability**: OpenTelemetry, Winston, Prometheus, Grafana
            - **Testing**: Jest with 90%+ coverage requirements

            ### Downloads

            | Platform | Architecture | Package |
            |----------|--------------|---------|
            | Linux | amd64 | RPM, DEB, tar.gz |
            | Linux | arm64 | RPM, DEB, tar.gz |
            | Windows | amd64 | ZIP (with installer) |
            | macOS | Intel (amd64) | DMG, tar.gz |
            | macOS | Apple Silicon (arm64) | DMG, tar.gz |
            | Source | All | tar.gz, zip |

            ### Installation

            **Linux (DEB - Debian/Ubuntu):**
            ```bash
            sudo dpkg -i telemetryflow-core_${{ needs.prepare.outputs.version }}_amd64.deb
            sudo systemctl start telemetryflow-core
            sudo systemctl enable telemetryflow-core
            ```

            **Linux (RPM - RHEL/CentOS/Fedora):**
            ```bash
            sudo rpm -i telemetryflow-core-${{ needs.prepare.outputs.version }}-1.x86_64.rpm
            sudo systemctl start telemetryflow-core
            sudo systemctl enable telemetryflow-core
            ```

            **macOS:**
            1. Open the DMG file
            2. Run `./install.sh` in Terminal
            3. Start: `sudo launchctl load /Library/LaunchDaemons/id.telemetryflow.core.plist`

            **Windows:**
            1. Extract the ZIP file
            2. Run `install.ps1` as Administrator
            3. Start: `Start-Service TelemetryFlowCore`

            ### Docker Images

            ```bash
            # Docker Hub
            docker pull telemetryflow/telemetryflow-core:${{ needs.prepare.outputs.version }}
            docker pull telemetryflow/telemetryflow-core:latest

            # GitHub Container Registry
            docker pull ghcr.io/${{ github.repository }}:${{ needs.prepare.outputs.version }}
            docker pull ghcr.io/${{ github.repository }}:latest
            ```

            ### Quick Start

            **Using Docker Compose:**
            ```bash
            # Download source
            wget https://github.com/${{ github.repository }}/releases/download/v${{ needs.prepare.outputs.version }}/telemetryflow-core-${{ needs.prepare.outputs.version }}-source.tar.gz
            tar -xzf telemetryflow-core-${{ needs.prepare.outputs.version }}-source.tar.gz
            cd telemetryflow-core-${{ needs.prepare.outputs.version }}-source

            # Start services
            docker-compose --profile core up -d
            ```

            **From Source:**
            ```bash
            # Extract and install
            tar -xzf telemetryflow-core-${{ needs.prepare.outputs.version }}-source.tar.gz
            cd telemetryflow-core-${{ needs.prepare.outputs.version }}-source
            ./install.sh

            # Configure and start
            cp .env.example .env
            # Edit .env with your settings
            pnpm db:migrate:seed
            pnpm start
            ```

            ### Default Users

            The system comes with pre-configured users for each RBAC tier:
            - Super Administrator: `superadmin.telemetryflow@telemetryflow.id`
            - Administrator: `administrator.telemetryflow@telemetryflow.id`
            - Developer: `developer.telemetryflow@telemetryflow.id`
            - Viewer: `viewer.telemetryflow@telemetryflow.id`
            - Demo: `demo.telemetryflow@telemetryflow.id`

            All default passwords follow the pattern: `{Role}@123456` (change in production).

            ### API Documentation

            Once running, access the Swagger UI at: `http://localhost:3000/api`

            ### Health Check

            ```bash
            curl http://localhost:3000/health
            ```

            ### Verification

            Verify downloads using SHA256 checksums in `checksums-sha256.txt`.

            ### Support

            - üìö [Documentation](https://docs.telemetryflow.id)
            - üêõ [Report Issues](https://github.com/${{ github.repository }}/issues)
            - üí¨ [Discussions](https://github.com/${{ github.repository }}/discussions)
            - üìß [Email Support](mailto:${{ env.MAINTAINER }})

            ---

            **Full Changelog**: https://github.com/${{ github.repository }}/compare/v${{ needs.prepare.outputs.version }}...HEAD Issues](https://github.com/telemetryflow/telemetryflow-go-sdk/issues)

  # ===========================================================================
  # Summary
  # ===========================================================================
  summary:
    name: Release Summary
    runs-on: ubuntu-latest
    needs:
      - prepare
      - build-docker
      - build-source
      - build-linux
      - build-windows
      - build-macos
      - package-rpm
      - package-deb
      - package-windows
      - package-macos
      - package-tarball
      - release
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## ${{ env.PRODUCT_NAME }} - Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | v${{ needs.prepare.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | ${{ needs.prepare.outputs.commit }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | ${{ needs.prepare.outputs.branch }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Build Time** | ${{ needs.prepare.outputs.build_time }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Components" >> $GITHUB_STEP_SUMMARY
          echo "- Identity and Access Management (IAM) Service" >> $GITHUB_STEP_SUMMARY
          echo "- 5-Tier RBAC System" >> $GITHUB_STEP_SUMMARY
          echo "- Multi-tenant Architecture" >> $GITHUB_STEP_SUMMARY
          echo "- OpenTelemetry Observability" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Status" >> $GITHUB_STEP_SUMMARY
          echo "| Type | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Linux Binaries | ${{ needs.build-linux.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Windows Binary | ${{ needs.build-windows.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS Binaries | ${{ needs.build-macos.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Images | ${{ needs.build-docker.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Source Archives | ${{ needs.build-source.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Package Status" >> $GITHUB_STEP_SUMMARY
          echo "| Type | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| RPM Packages | ${{ needs.package-rpm.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| DEB Packages | ${{ needs.package-deb.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Windows ZIP | ${{ needs.package-windows.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS DMG | ${{ needs.package-macos.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tarballs | ${{ needs.package-tarball.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| GitHub Release | ${{ needs.release.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Docker Images" >> $GITHUB_STEP_SUMMARY
          echo "- \`telemetryflow/telemetryflow-core:${{ needs.prepare.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`ghcr.io/${{ github.repository }}:${{ needs.prepare.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Platform Packages" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Architecture | Packages |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Linux | amd64 | RPM, DEB, tar.gz |" >> $GITHUB_STEP_SUMMARY
          echo "| Linux | arm64 | RPM, DEB, tar.gz |" >> $GITHUB_STEP_SUMMARY
          echo "| Windows | amd64 | ZIP (with installer) |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS | Intel | DMG, tar.gz |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS | Apple Silicon | DMG, tar.gz |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quick Start" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Docker" >> $GITHUB_STEP_SUMMARY
          echo "docker run -d --name telemetryflow-core \\" >> $GITHUB_STEP_SUMMARY
          echo "  -p 3000:3000 \\" >> $GITHUB_STEP_SUMMARY
          echo "  -e POSTGRES_HOST=your-postgres-host \\" >> $GITHUB_STEP_SUMMARY
          echo "  -e JWT_SECRET=your-jwt-secret \\" >> $GITHUB_STEP_SUMMARY
          echo "  telemetryflow/telemetryflow-core:${{ needs.prepare.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Linux (DEB)" >> $GITHUB_STEP_SUMMARY
          echo "sudo dpkg -i telemetryflow-core_${{ needs.prepare.outputs.version }}_amd64.deb" >> $GITHUB_STEP_SUMMARY
          echo "sudo systemctl start telemetryflow-core" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
