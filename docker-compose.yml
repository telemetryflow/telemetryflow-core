#================================================================================================
# TelemetryFlow Core - Docker Compose Configuration
# IAM Module Only (PostgreSQL + Backend)
#
# PROFILES:
# - core: Essential services (postgres, clickhouse, backend) - No monitoring
# - monitoring: Observability stack (otel-collector, jaeger, prometheus, grafana)
# - tools: Management tools (portainer)
# - all: All services combined
#
# USAGE:
# docker-compose --profile core up -d              # Core services only
# docker-compose --profile core --profile monitoring up -d  # Core + monitoring
# docker-compose --profile all up -d               # All services
#================================================================================================

#================================================================================================
# NETWORK SETUP
#================================================================================================
networks:
  telemetryflow_core_net:
    name: telemetryflow_core_net
    driver: bridge
    ipam:
      config:
        - subnet: 172.151.0.0/16

#================================================================================================
# VOLUME SETUP
#================================================================================================
volumes:
  vol_postgres_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/data/docker/telemetryflow-core/postgres
  vol_clickhouse_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/data/docker/telemetryflow-core/clickhouse/data
  vol_clickhouse_logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/data/docker/telemetryflow-core/clickhouse/logs
  vol_prometheus_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/data/docker/telemetryflow-core/prometheus
  vol_grafana_data:
  vol_portainer:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/data/docker/telemetryflow-core/portainer

#================================================================================================
# SERVICES
#================================================================================================
services:
  #----------------------------------------------------------------------------------------------
  # POSTGRESQL - IAM Data Storage
  #----------------------------------------------------------------------------------------------
  postgres:
    profiles: ["core", "all"]
    platform: linux/amd64
    image: postgres:${POSTGRES_VERSION:-16-alpine}
    container_name: ${CONTAINER_POSTGRES:-telemetryflow_core_postgres}
    restart: unless-stopped
    ports:
      - "${PORT_POSTGRES:-5432}:5432"
    environment:
      - TZ=${TZ:-UTC}
      - POSTGRES_USER=${POSTGRES_USERNAME:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-telemetryflow123}
      - POSTGRES_DB=${POSTGRES_DB:-telemetryflow_db}
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - vol_postgres_data:/var/lib/postgresql/data
      - ./config/postgresql/postgresql.conf:/etc/postgresql/postgresql.conf:ro
    networks:
      telemetryflow_core_net:
        ipv4_address: ${CONTAINER_IP_POSTGRES:-172.151.151.20}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USERNAME:-postgres} -d ${POSTGRES_DB:-telemetryflow_core}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  #----------------------------------------------------------------------------------------------
  # BACKEND - NestJS API (Core Profile - No OTEL dependency)
  #----------------------------------------------------------------------------------------------
  backend:
    profiles: ["core"]
    platform: linux/amd64
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ${CONTAINER_BACKEND:-telemetryflow_core_backend}
    restart: unless-stopped
    ports:
      - "${PORT:-3000}:3000"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=3000
      - TZ=${TZ:-UTC}

      # PostgreSQL
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=${POSTGRES_DB:-telemetryflow_db}
      - POSTGRES_USERNAME=${POSTGRES_USERNAME:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-telemetryflow123}

      # ClickHouse
      - CLICKHOUSE_HOST=clickhouse
      - CLICKHOUSE_PORT=8123
      - CLICKHOUSE_DB=${CLICKHOUSE_DB:-telemetryflow_db}
      - CLICKHOUSE_USER=${CLICKHOUSE_USER:-default}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD:-telemetryflow123}

      # JWT
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-24h}
      - SESSION_SECRET=${SESSION_SECRET}

      # Logging
      - LOGGER_TYPE=${LOGGER_TYPE:-winston}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - LOG_PRETTY_PRINT=${LOG_PRETTY_PRINT:-false}
      - LOG_FILE_ENABLED=${LOG_FILE_ENABLED:-true}
      - LOG_FILE_DIRNAME=logs
      - LOG_FILE_FILENAME=app-%DATE%.log

      # OpenTelemetry (disabled for core profile)
      - OTEL_ENABLED=false
      - OTEL_SERVICE_NAME=${OTEL_SERVICE_NAME:-telemetryflow-core}
    volumes:
      - ./logs:/app/logs
    depends_on:
      postgres:
        condition: service_healthy
      clickhouse:
        condition: service_healthy
    networks:
      telemetryflow_core_net:
        ipv4_address: ${CONTAINER_IP_BACKEND:-172.151.151.10}
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  #----------------------------------------------------------------------------------------------
  # BACKEND - NestJS API (All Profile - With OTEL dependency)
  #----------------------------------------------------------------------------------------------
  backend-with-monitoring:
    profiles: ["all"]
    platform: linux/amd64
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ${CONTAINER_BACKEND:-telemetryflow_core_backend}
    restart: unless-stopped
    ports:
      - "${PORT:-3000}:3000"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=3000
      - TZ=${TZ:-UTC}

      # PostgreSQL
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=${POSTGRES_DB:-telemetryflow_db}
      - POSTGRES_USERNAME=${POSTGRES_USERNAME:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-telemetryflow123}

      # ClickHouse
      - CLICKHOUSE_HOST=clickhouse
      - CLICKHOUSE_PORT=8123
      - CLICKHOUSE_DB=${CLICKHOUSE_DB:-telemetryflow_db}
      - CLICKHOUSE_USER=${CLICKHOUSE_USER:-default}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD:-telemetryflow123}

      # JWT
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-24h}
      - SESSION_SECRET=${SESSION_SECRET}

      # Logging
      - LOGGER_TYPE=${LOGGER_TYPE:-winston}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - LOG_PRETTY_PRINT=${LOG_PRETTY_PRINT:-false}
      - LOG_FILE_ENABLED=${LOG_FILE_ENABLED:-true}
      - LOG_FILE_DIRNAME=logs
      - LOG_FILE_FILENAME=app-%DATE%.log

      # OpenTelemetry (enabled for all profile)
      - OTEL_ENABLED=${OTEL_ENABLED:-true}
      - OTEL_SERVICE_NAME=${OTEL_SERVICE_NAME:-telemetryflow-core}
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4318
    volumes:
      - ./logs:/app/logs
    depends_on:
      postgres:
        condition: service_healthy
      clickhouse:
        condition: service_healthy
      otel-collector:
        condition: service_started
    networks:
      telemetryflow_core_net:
        ipv4_address: ${CONTAINER_IP_BACKEND:-172.151.151.10}
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  #----------------------------------------------------------------------------------------------
  # CLICKHOUSE - Audit Log Storage
  #----------------------------------------------------------------------------------------------
  clickhouse:
    profiles: ["core", "all"]
    platform: linux/amd64
    image: clickhouse/clickhouse-server:${CLICKHOUSE_VERSION:-latest}
    container_name: ${CONTAINER_CLICKHOUSE:-telemetryflow_core_clickhouse}
    restart: unless-stopped
    ports:
      - "${PORT_CLICKHOUSE_HTTP:-8123}:8123"    # HTTP
      - "${PORT_CLICKHOUSE_NATIVE:-9000}:9000"  # Native
      - "${PORT_CLICKHOUSE_METRICS:-9363}:9363" # Prometheus metrics
    environment:
      - TZ=${TZ:-UTC}
      - CLICKHOUSE_DB=${CLICKHOUSE_DB:-telemetryflow_db}
      - CLICKHOUSE_USER=${CLICKHOUSE_USER:-default}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD:-telemetryflow123}
    volumes:
      - vol_clickhouse_data:/var/lib/clickhouse
      - vol_clickhouse_logs:/var/log/clickhouse-server
    # - ./config/clickhouse/config.d:/etc/clickhouse-server/config.d
    networks:
      telemetryflow_core_net:
        ipv4_address: ${CONTAINER_IP_CLICKHOUSE:-172.151.151.40}
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8123/ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  #----------------------------------------------------------------------------------------------
  # OTEL COLLECTOR - OpenTelemetry Collector
  #----------------------------------------------------------------------------------------------
  # Supports dual ingestion: v1 (OTEL standard) and v2 (TelemetryFlow enhanced)
  #
  # OTLP HTTP Endpoints:
  #   TelemetryFlow Platform (Recommended - TFO Standalone):
  #     POST http://localhost:4318/v2/traces
  #     POST http://localhost:4318/v2/metrics
  #     POST http://localhost:4318/v2/logs
  #
  #   OTEL Community (Backwards Compatible - OCB/Standard):
  #     POST http://localhost:4318/v1/traces
  #     POST http://localhost:4318/v1/metrics
  #     POST http://localhost:4318/v1/logs
  #
  #   gRPC (Both versions via same port): localhost:4317
  #----------------------------------------------------------------------------------------------
  otel-collector:
    profiles: ["monitoring", "all"]
    platform: linux/amd64
    # =============================================================================
    # TelemetryFlow Collector (TFO-Collector) - Custom TFO format with OTLP support (v1.1.1+)
    image: telemetryflow/telemetryflow-collector:${TFO_VERSION:-latest}
    # command: ["--config=/etc/tfo-collector/tfo-collector.yaml"]
    # =============================================================================
    # TelemetryFlow Collector OCB (TFO-Collector-OCB) - Standard OTEL format
    # image: telemetryflow/telemetryflow-collector-ocb:${TFO_VERSION:-latest}
    # command: ["--config=/etc/tfo-collector/otel-collector.yaml"]
    # =============================================================================
    # OTEL Collector Community Contributor (Standard OTEL format)
    # image: otel/opentelemetry-collector-contrib:${OTEL_VERSION:-0.142.0}
    # command: ["--config=/etc/otelcol-contrib/config.yaml"]
    # =============================================================================
    container_name: ${CONTAINER_OTEL:-telemetryflow_core_otel}
    restart: unless-stopped
    volumes:
      # TelemetryFlow Collector config (Custom TFO format)
      - ./config/otel/tfo-collector.yaml:/etc/tfo-collector/tfo-collector.yaml:ro
      # =============================================================================
      # TelemetryFlow Collector OCB config (Standard OTEL format)
      # - ./config/otel/otel-collector.yaml:/etc/tfo-collector/otel-collector.yaml:ro
      # =============================================================================
      # OTEL Collector Community Contributor config (Standard OTEL format)
      # - ./config/otel/otel-collector.yaml:/etc/otelcol-contrib/config.yaml:ro
    ports:
      - "${PORT_OTEL_GRPC:-4317}:4317"     # OTLP gRPC (v1 & v2)
      - "${PORT_OTEL_HTTP:-4318}:4318"     # OTLP HTTP (v1 & v2)
      - "${PORT_OTEL_METRICS:-8889}:8889"  # Prometheus metrics
      - "${PORT_OTEL_HEALTH:-13133}:13133" # Health check
      - "${PORT_OTEL_ZPAGES:-55679}:55679" # zPages
      - "${PORT_OTEL_PPROF:-1777}:1777"    # pprof
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:13133"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      telemetryflow_core_net:
        ipv4_address: ${CONTAINER_IP_OTEL:-172.151.151.30}

  #----------------------------------------------------------------------------------------------
  # JAEGER V2 - Distributed Tracing UI (OpenTelemetry-based)
  #----------------------------------------------------------------------------------------------
  jaeger:
    profiles: ["monitoring", "all"]
    platform: linux/amd64
    image: jaegertracing/jaeger:${JAEGER_VERSION:-2.13.0}
    container_name: ${CONTAINER_JAEGER:-telemetryflow_core_jaeger}
    restart: unless-stopped
    ports:
      - "${PORT_JAEGER_UI:-16686}:16686"   # Jaeger UI
    environment:
      - SPAN_STORAGE_TYPE=memory
      - METRICS_STORAGE_TYPE=prometheus
      - PROMETHEUS_SERVER_URL=http://prometheus:9090
      - PROMETHEUS_QUERY_SUPPORT_SPANMETRICS_CONNECTOR=true
      - PROMETHEUS_QUERY_NAMESPACE=telemetryflow_core
      - PROMETHEUS_QUERY_DURATION_UNIT=ms
      - PROMETHEUS_QUERY_NORMALIZE_CALLS=true
      - PROMETHEUS_QUERY_NORMALIZE_DURATION=true
    networks:
      telemetryflow_core_net:
        ipv4_address: ${CONTAINER_IP_JAEGER:-172.151.151.60}
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:16686"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    depends_on:
      - prometheus

  #----------------------------------------------------------------------------------------------
  # PROMETHEUS - Metrics Collection
  #----------------------------------------------------------------------------------------------
  prometheus:
    profiles: ["monitoring", "all"]
    platform: linux/amd64
    image: prom/prometheus:${PROMETHEUS_VERSION:-latest}
    container_name: ${CONTAINER_PROMETHEUS:-telemetryflow_core_prometheus}
    restart: unless-stopped
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    ports:
      - "${PORT_PROMETHEUS:-9090}:9090"
    volumes:
      - ./config/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - vol_prometheus_data:/prometheus
    networks:
      telemetryflow_core_net:
        ipv4_address: ${CONTAINER_IP_PROMETHEUS:-172.151.151.50}
    depends_on:
      - otel-collector
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9090/-/healthy"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  #----------------------------------------------------------------------------------------------
  # GRAFANA - Metrics Visualization & SPM Dashboards
  #----------------------------------------------------------------------------------------------
  grafana:
    profiles: ["monitoring", "all"]
    platform: linux/amd64
    image: grafana/grafana:${GRAFANA_VERSION:-latest}
    container_name: ${CONTAINER_GRAFANA:-telemetryflow_core_grafana}
    restart: unless-stopped
    ports:
      - "${PORT_GRAFANA:-3001}:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GF_SECURITY_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GF_SECURITY_ADMIN_PASSWORD:-admin}
    volumes:
      - vol_grafana_data:/var/lib/grafana
      - ./config/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./config/grafana/dashboards:/var/lib/grafana/dashboards:ro
    networks:
      telemetryflow_core_net:
        ipv4_address: ${CONTAINER_IP_GRAFANA:-172.151.151.70}
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    depends_on:
      - prometheus

  #----------------------------------------------------------------------------------------------
  # PORTAINER - Docker Container Management UI
  #----------------------------------------------------------------------------------------------
  portainer:
    profiles: ["tools", "all"]
    platform: linux/amd64
    image: portainer/portainer-ce:${PORTAINER_VERSION:-latest}
    container_name: ${CONTAINER_PORTAINER:-telemetryflow_core_portainer}
    restart: unless-stopped
    ports:
      - "${PORT_PORTAINER:-9100}:9000"
      - "${PORT_PORTAINER_HTTPS:-9443}:9443"
    environment:
      - TZ=${TZ:-UTC}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - vol_portainer:/data
    networks:
      telemetryflow_core_net:
        ipv4_address: ${CONTAINER_IP_PORTAINER:-172.151.151.5}
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9000/api/status"]
      interval: 30s
      timeout: 5s
      retries: 3
